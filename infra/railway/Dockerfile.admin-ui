FROM golang:1.22 AS builder
WORKDIR /app

ENV GOSUMDB=off
ENV GOPROXY=https://proxy.golang.org,direct

COPY go.mod ./
RUN go mod download

COPY . .
RUN CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -o /tmp/admin-ui ./cmd/admin-ui

FROM debian:bookworm-slim

RUN apt-get update && apt-get install -y --no-install-recommends \
    ca-certificates \
    curl \
    gnupg && \
    curl -fsSL https://pkgs.tailscale.com/stable/debian/bookworm.noarmor.gpg | tee /usr/share/keyrings/tailscale-archive-keyring.gpg >/dev/null && \
    curl -fsSL https://pkgs.tailscale.com/stable/debian/bookworm.tailscale-keyring.list | tee /etc/apt/sources.list.d/tailscale.list >/dev/null && \
    apt-get update && apt-get install -y --no-install-recommends tailscale && \
    rm -rf /var/lib/apt/lists/*

WORKDIR /app

COPY --from=builder /tmp/admin-ui /usr/local/bin/admin-ui
COPY infra/railway/entrypoint-admin-ui.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

ENV ADMIN_UI_LISTEN_ADDR=":8100"

ENTRYPOINT ["/entrypoint.sh"]
